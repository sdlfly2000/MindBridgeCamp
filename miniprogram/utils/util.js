"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GetLocalUserInformation = exports.Login = exports.IsLoginTokenValid = exports.UpdateUserInfo = exports.webClient = exports.FormatTime = exports.FormatDate = exports.formatTime = void 0;
exports.formatTime = function (date) {
    var year = date.getFullYear();
    var month = date.getMonth() + 1;
    var day = date.getDate();
    var hour = date.getHours();
    var minute = date.getMinutes();
    var second = date.getSeconds();
    return ([year, month, day].map(formatNumber).join('-') +
        ' ' +
        [hour, minute, second].map(formatNumber).join(':'));
};
var formatNumber = function (n) {
    var s = n.toString();
    return s[1] ? s : '0' + s;
};
exports.FormatDate = function (date) {
    return [date.getFullYear(), date.getMonth() + 1, date.getDate()].map(formatNumber).join('-');
};
exports.FormatTime = function (date) {
    return [date.getHours(), date.getMinutes()].map(formatNumber).join(':');
};
exports.webClient = function (url, httpMethod, requestData) {
    return new Promise(function (resolve, error) {
        wx.request({
            url: url,
            method: httpMethod,
            data: requestData,
            success: function (res) {
                if (res.statusCode == 200) {
                    resolve(res);
                }
                else {
                    error(res);
                }
            },
            fail: function (e) {
                console.error(e);
            }
        });
    });
};
exports.UpdateUserInfo = function (app, userInfo) {
    var loginToken = wx.getStorageSync("LoginToken");
    var updateUserInfoUrl = app.globalData.baseUrlApp + "User/UpdateUserInfo/" + loginToken;
    var userInfoData = {
        NickName: userInfo.NickName,
        AvatarUrl: userInfo.AvatarUrl,
        Country: userInfo.Country,
        Province: userInfo.Province,
        City: userInfo.City,
        Language: userInfo.Language
    };
    exports.webClient(updateUserInfoUrl, "POST", userInfoData)
        .catch(function (res) { return console.error(res); });
};
exports.IsLoginTokenValid = function (app) {
    var loginToken = wx.getStorageSync("LoginToken");
    return new Promise(function (resolve, error) {
        if (loginToken == '') {
            error("LoginToken is undefined");
        }
        else {
            wx.request({
                url: app.globalData.baseUrlAuth + "WeixinLogin/IsLoginTokenValid/" + loginToken,
                success: function (res) {
                    if (res.statusCode == 200) {
                        resolve(res);
                    }
                    else {
                        error(res);
                    }
                },
                fail: function (e) {
                    console.error(e);
                }
            });
        }
    });
};
exports.Login = function (app) {
    return new Promise(function (resolve, error) {
        wx.login({
            success: function (res) {
                console.info("Login Code: " + res.code);
                wx.request({
                    url: app.globalData.baseUrlAuth + "WeixinLogin/GetToken",
                    data: {
                        LoginCode: res.code,
                        AppName: app.globalData.appName
                    },
                    header: {
                        'content-type': 'application/json'
                    },
                    method: 'POST',
                    success: function (response) {
                        if (response.data != undefined) {
                            wx.setStorageSync('LoginToken', response.data);
                            console.info("Login Token: " + response.data);
                            resolve(response);
                        }
                        else {
                            error(response);
                        }
                    },
                    fail: function (res) {
                        error(res);
                    }
                });
            },
        });
    });
};
exports.GetLocalUserInformation = function (app) {
    app.userInfoReadyCallback = function (res) {
        app.globalData.userInfo = res.userInfo;
    };
    wx.getSetting({
        success: function (res) {
            if (res.authSetting['scope.userInfo']) {
                wx.getUserInfo({
                    success: function (res) {
                        app.globalData.userInfo = res.userInfo;
                        console.info("UserInfoï¼š" + JSON.stringify(res.userInfo));
                        if (app.userInfoReadyCallback) {
                            app.userInfoReadyCallback(res);
                        }
                    }
                });
            }
        }
    });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQWEsUUFBQSxVQUFVLEdBQUcsVUFBQyxJQUFVO0lBQ25DLElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQTtJQUMvQixJQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFBO0lBQ2pDLElBQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQTtJQUMxQixJQUFNLElBQUksR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUE7SUFDNUIsSUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFBO0lBQ2hDLElBQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQTtJQUVoQyxPQUFPLENBQ0wsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO1FBQzlDLEdBQUc7UUFDSCxDQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FDbkQsQ0FBQTtBQUNILENBQUMsQ0FBQTtBQUVELElBQU0sWUFBWSxHQUFHLFVBQUMsQ0FBUztJQUM3QixJQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUE7SUFDdEIsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQTtBQUMzQixDQUFDLENBQUE7QUFFWSxRQUFBLFVBQVUsR0FBRyxVQUFTLElBQVU7SUFDM0MsT0FBTyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsRUFBRSxJQUFJLENBQUMsUUFB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QztTQUNGLENBQUMsQ0FBQTtJQUNKLENBQUMsQ0FDRixDQUFBO0FBQ0gsQ0FBQyxDQUFBO0FBRVksUUFBQSx1QkFBdUIsR0FBRyxVQUFTLEdBQWU7SUFDN0QsR0FBRyxDQUFDLHFCQUFxQixHQUFHLFVBQUEsR0FBRztRQUM3QixHQUFHLENBQUMsVUFBVSxDQUFDLFFBQVEsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFBO0lBQ3hDLENBQUMsQ0FBQTtJQUNELEVBQUUsQ0FBQyxVQUFVLENBQUM7UUFDWixPQUFPLEVBQUUsVUFBQSxHQUFHO1lBQ1YsSUFBRyxHQUFHLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLEVBQUM7Z0JBQ25DLEVBQUUsQ0FBQyxXQUFXLENBQUM7b0JBQ2IsT0FBTyxFQUFFLFVBQUEsR0FBRzt3QkFDVixHQUFHLENBQUMsVUFBVSxDQUFDLFFBQVEsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDO3dCQUN2QyxPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO3dCQUN6RCxJQUFHLEdBQUcsQ0FBQyxxQkFBcUIsRUFBQzs0QkFDM0IsR0FBRyxDQUFDLHFCQUFxQixDQUFDLEdBQUcsQ0FBQyxDQUFDO3lCQUNoQztvQkFDSCxDQUFDO2lCQUNGLENBQUMsQ0FBQTthQUNIO1FBQ0gsQ0FBQztLQUNGLENBQUMsQ0FBQTtBQUNKLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImV4cG9ydCBjb25zdCBmb3JtYXRUaW1lID0gKGRhdGU6IERhdGUpID0+IHtcclxuICBjb25zdCB5ZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpXHJcbiAgY29uc3QgbW9udGggPSBkYXRlLmdldE1vbnRoKCkgKyAxXHJcbiAgY29uc3QgZGF5ID0gZGF0ZS5nZXREYXRlKClcclxuICBjb25zdCBob3VyID0gZGF0ZS5nZXRIb3VycygpXHJcbiAgY29uc3QgbWludXRlID0gZGF0ZS5nZXRNaW51dGVzKClcclxuICBjb25zdCBzZWNvbmQgPSBkYXRlLmdldFNlY29uZHMoKVxyXG5cclxuICByZXR1cm4gKFxyXG4gICAgW3llYXIsIG1vbnRoLCBkYXldLm1hcChmb3JtYXROdW1iZXIpLmpvaW4oJy0nKSArXHJcbiAgICAnICcgK1xyXG4gICAgW2hvdXIsIG1pbnV0ZSwgc2Vjb25kXS5tYXAoZm9ybWF0TnVtYmVyKS5qb2luKCc6JylcclxuICApXHJcbn1cclxuXHJcbmNvbnN0IGZvcm1hdE51bWJlciA9IChuOiBudW1iZXIpID0+IHtcclxuICBjb25zdCBzID0gbi50b1N0cmluZygpXHJcbiAgcmV0dXJuIHNbMV0gPyBzIDogJzAnICsgc1xyXG59XHJcblxyXG5leHBvcnQgY29uc3QgRm9ybWF0RGF0ZSA9IGZ1bmN0aW9uKGRhdGU6IERhdGUpe1xyXG4gIHJldHVybiBbZGF0ZS5nZXRGdWxsWWVhcigpLCBkYXRlLmdldE1vbnRoKCkgKyAxLCBkYXRlLmdldERhdGUoKV0ubWFwKGZvcm1hdE51bWJlcikuam9pbignLScpO1xyXG59XHJcblxyXG5leHBvcnQgY29uc3QgRm9ybWF0VGltZSA9IGZ1bmN0aW9uKGRhdGU6IERhdGUpe1xyXG4gIHJldHVybiBbZGF0ZS5nZXRIb3VycygpLCBkYXRlLmdldE1pbnV0ZXMoKV0ubWFwKGZvcm1hdE51bWJlcikuam9pbignOicpO1xyXG59XHJcblxyXG5leHBvcnQgY29uc3Qgd2ViQ2xpZW50ID0gZnVuY3Rpb24odXJsOiBzdHJpbmcsIGh0dHBNZXRob2Q/OiBhbnksIHJlcXVlc3REYXRhPzogYW55KXtcclxuICByZXR1cm4gbmV3IFByb21pc2UoXHJcbiAgICAocmVzb2x2ZSwgZXJyb3IpID0+IHtcclxuICAgICAgd3gucmVxdWVzdCh7XHJcbiAgICAgICAgdXJsOiB1cmwsXHJcbiAgICAgICAgbWV0aG9kOiBodHRwTWV0aG9kLFxyXG4gICAgICAgIGRhdGE6IHJlcXVlc3REYXRhLFxyXG4gICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKHJlcyl7XHJcbiAgICAgICAgICBpZihyZXMuc3RhdHVzQ29kZSA9PSAyMDApe1xyXG4gICAgICAgICAgICByZXNvbHZlKHJlcyk7ICAgICAgICAgICAgXHJcbiAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgZXJyb3IocmVzKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIGZhaWw6IGZ1bmN0aW9uKGUpe1xyXG4gICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICk7XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCBVcGRhdGVVc2VySW5mbyA9IGZ1bmN0aW9uKGFwcDogSUFwcE9wdGlvbiwgdXNlckluZm86IGFueSl7XHJcbiAgbGV0IGxvZ2luVG9rZW46c3RyaW5nID0gd3guZ2V0U3RvcmFnZVN5bmMoXCJMb2dpblRva2VuXCIpO1xyXG4gIGxldCB1cGRhdGVVc2VySW5mb1VybDogc3RyaW5nID0gYXBwLmdsb2JhbERhdGEuYmFzZVVybEFwcCArIFwiVXNlci9VcGRhdGVVc2VySW5mby9cIiArIGxvZ2luVG9rZW47XHJcbiAgbGV0IHVzZXJJbmZvRGF0YSA9IHtcclxuXHROaWNrTmFtZTogdXNlckluZm8uTmlja05hbWUsXHJcblx0QXZhdGFyVXJsOiB1c2VySW5mby5BdmF0YXJVcmwsXHJcblx0Q291bnRyeTogdXNlckluZm8uQ291bnRyeSxcclxuXHRQcm92aW5jZTogdXNlckluZm8uUHJvdmluY2UsXHJcblx0Q2l0eTogdXNlckluZm8uQ2l0eSxcclxuXHRMYW5ndWFnZTogdXNlckluZm8uTGFuZ3VhZ2VcclxuICB9XHJcbiAgd2ViQ2xpZW50KHVwZGF0ZVVzZXJJbmZvVXJsLCBcIlBPU1RcIiwgdXNlckluZm9EYXRhKVxyXG5cdC5jYXRjaCgocmVzKSA9PiBjb25zb2xlLmVycm9yKHJlcykpO1xyXG59XHJcblxyXG5leHBvcnQgY29uc3QgSXNMb2dpblRva2VuVmFsaWQgPSBmdW5jdGlvbihhcHA6IElBcHBPcHRpb24pe1xyXG4gIGxldCBsb2dpblRva2VuOnN0cmluZyA9IHd4LmdldFN0b3JhZ2VTeW5jKFwiTG9naW5Ub2tlblwiKTtcclxuICByZXR1cm4gbmV3IFByb21pc2UoXHJcbiAgICAocmVzb2x2ZSwgZXJyb3IpID0+IHtcclxuICAgICAgaWYobG9naW5Ub2tlbiA9PSAnJyl7XHJcbiAgICAgICAgZXJyb3IoXCJMb2dpblRva2VuIGlzIHVuZGVmaW5lZFwiKTtcclxuICAgICAgfWVsc2V7XHJcbiAgICAgICAgd3gucmVxdWVzdCh7XHJcbiAgICAgICAgICB1cmw6IGFwcC5nbG9iYWxEYXRhLmJhc2VVcmxBdXRoICsgXCJXZWl4aW5Mb2dpbi9Jc0xvZ2luVG9rZW5WYWxpZC9cIiArIGxvZ2luVG9rZW4sXHJcbiAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihyZXMpe1xyXG4gICAgICAgICAgICBpZihyZXMuc3RhdHVzQ29kZSA9PSAyMDApe1xyXG4gICAgICAgICAgICAgIHJlc29sdmUocmVzKTtcclxuICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgZXJyb3IocmVzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgIGZhaWw6IGZ1bmN0aW9uKGUpe1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgKTtcclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IExvZ2luID0gZnVuY3Rpb24oYXBwOiBJQXBwT3B0aW9uKXtcclxuICByZXR1cm4gbmV3IFByb21pc2UoXHJcbiAgICAocmVzb2x2ZSwgZXJyb3IpID0+IHtcclxuICAgICAgd3gubG9naW4oe1xyXG4gICAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XHJcbiAgICAgICAgICBjb25zb2xlLmluZm8oXCJMb2dpbiBDb2RlOiBcIiArIHJlcy5jb2RlKTsgICAgICBcclxuICAgICAgICAgIHd4LnJlcXVlc3Qoe1xyXG4gICAgICAgICAgICB1cmw6IGFwcC5nbG9iYWxEYXRhLmJhc2VVcmxBdXRoICsgXCJXZWl4aW5Mb2dpbi9HZXRUb2tlblwiLFxyXG4gICAgICAgICAgICBkYXRhOntcclxuICAgICAgICAgICAgICBMb2dpbkNvZGU6IHJlcy5jb2RlLFxyXG4gICAgICAgICAgICAgIEFwcE5hbWU6IGFwcC5nbG9iYWxEYXRhLmFwcE5hbWVcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgaGVhZGVyOiB7XHJcbiAgICAgICAgICAgICAgJ2NvbnRlbnQtdHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcclxuICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24ocmVzcG9uc2UpeyAgICAgICAgICBcclxuICAgICAgICAgICAgICBpZihyZXNwb25zZS5kYXRhICE9IHVuZGVmaW5lZCl7XHJcbiAgICAgICAgICAgICAgICB3eC5zZXRTdG9yYWdlU3luYygnTG9naW5Ub2tlbicsIHJlc3BvbnNlLmRhdGEpXHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmluZm8oXCJMb2dpbiBUb2tlbjogXCIgKyByZXNwb25zZS5kYXRhKTsgXHJcbiAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgIGVycm9yKHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGZhaWw6IGZ1bmN0aW9uKHJlcyl7XHJcbiAgICAgICAgICAgICAgZXJyb3IocmVzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSlcclxuICAgICAgICB9LFxyXG4gICAgICB9KSBcclxuICAgIH1cclxuICApIFxyXG59XHJcblxyXG5leHBvcnQgY29uc3QgR2V0TG9jYWxVc2VySW5mb3JtYXRpb24gPSBmdW5jdGlvbihhcHA6IElBcHBPcHRpb24pe1xyXG4gIGFwcC51c2VySW5mb1JlYWR5Q2FsbGJhY2sgPSByZXMgPT4ge1xyXG4gICAgYXBwLmdsb2JhbERhdGEudXNlckluZm8gPSByZXMudXNlckluZm8gICAgICAgIFxyXG4gIH1cclxuICB3eC5nZXRTZXR0aW5nKHtcclxuICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XHJcbiAgICAgIGlmKHJlcy5hdXRoU2V0dGluZ1snc2NvcGUudXNlckluZm8nXSl7XHJcbiAgICAgICAgd3guZ2V0VXNlckluZm8oe1xyXG4gICAgICAgICAgc3VjY2VzczogcmVzID0+IHtcclxuICAgICAgICAgICAgYXBwLmdsb2JhbERhdGEudXNlckluZm8gPSByZXMudXNlckluZm87XHJcbiAgICAgICAgICAgIGNvbnNvbGUuaW5mbyhcIlVzZXJJbmZv77yaXCIgKyBKU09OLnN0cmluZ2lmeShyZXMudXNlckluZm8pKTtcclxuICAgICAgICAgICAgaWYoYXBwLnVzZXJJbmZvUmVhZHlDYWxsYmFjayl7XHJcbiAgICAgICAgICAgICAgYXBwLnVzZXJJbmZvUmVhZHlDYWxsYmFjayhyZXMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH0pXHJcbn0iXX0=